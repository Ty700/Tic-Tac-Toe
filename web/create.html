<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicTacToe â€” Create Game</title>
    <link rel="stylesheet" href="/tictactoe/styles/game.css">
</head>
<body>
    <div class="content" style="opacity: 1;">
        <nav class="nav">
            <a href="/tictactoe/create-game" class="logo">TicTacToe</a>
            <div class="nav-links">
                <a href="https://ty700.tech">Portfolio</a>
                <a href="https://github.com/Ty700/Tic-Tac-Toe" target="_blank">Source</a>
            </div>
        </nav>

        <main class="game-container">
            <div class="hero-mini">
                <h1 class="hero-title">TicTacToe</h1>
                <p class="hero-sub">Play the classic game online with a friend.</p>
            </div>

            <div class="create-grid">
                <!-- Create Game Card -->
                <div class="action-card">
                    <div class="action-card-icon">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <line x1="50" y1="25" x2="50" y2="75" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                            <line x1="25" y1="50" x2="75" y2="50" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2>Create Game</h2>
                    <p>Start a new game and invite a friend with your game code.</p>
                    <form id="createForm" class="inline-form">
                        <input 
                            type="text" 
                            name="playerName" 
                            id="createName"
                            class="form-input" 
                            placeholder="Your name" 
                            required
                            maxlength="20"
                            autocomplete="off"
                        >
                        <button type="submit" class="btn btn-primary btn-full" id="createBtn">
                            Create Game
                        </button>
                    </form>
                </div>

                <!-- Join Game Card -->
                <div class="action-card">
                    <div class="action-card-icon">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <path d="M30 50 L45 65 L70 35" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h2>Join Game</h2>
                    <p>Have a game code? Enter it below to join your friend's game.</p>
                    <form id="joinForm" class="inline-form">
                        <input 
                            type="text" 
                            name="playerName" 
                            id="joinName"
                            class="form-input" 
                            placeholder="Your name" 
                            required
                            maxlength="20"
                            autocomplete="off"
                        >
                        <input 
                            type="text" 
                            name="gameId" 
                            id="joinGameId"
                            class="form-input" 
                            placeholder="4-digit game code" 
                            required
                            maxlength="4"
                            pattern="[0-9]{4}"
                            inputmode="numeric"
                            autocomplete="off"
                        >
                        <button type="submit" class="btn btn-secondary btn-full" id="joinBtn">
                            Join Game
                        </button>
                    </form>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Tyler Scotti &middot; <a href="https://ty700.tech">ty700.tech</a></p>
        </footer>
    </div>

    <script>
        const BASE = '/tictactoe';

        // Create game
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('createBtn');
            const name = document.getElementById('createName').value.trim();
            if (!name) return;

            btn.textContent = 'Creating...';
            btn.disabled = true;

            try {
                const formData = new URLSearchParams();
                formData.append('playerName', name);

                // Use redirect:'follow' so the browser follows the server's 302
                // The final URL will contain the game ID
                const res = await fetch(BASE + '/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString(),
                    redirect: 'follow'
                });

                if (res.ok || res.redirected) {
                    const finalUrl = res.url;
                    // Final URL: https://ty700.tech/tictactoe/game/5589
                    const urlPath = new URL(finalUrl).pathname;
                    const gameID = urlPath.split('/').pop();

                    if (gameID && /^\d{4}$/.test(gameID)) {
                        sessionStorage.setItem('ttt_playerName', name);
                        sessionStorage.setItem('ttt_playerNum', '1');
                        sessionStorage.setItem('ttt_gameID', gameID);
                        window.location.href = BASE + '/play/' + gameID;
                        return;
                    }

                    // Fallback: scan response body for a 4-digit ID
                    const body = await res.text();
                    const match = body.match(/\b(\d{4})\b/);
                    if (match) {
                        sessionStorage.setItem('ttt_playerName', name);
                        sessionStorage.setItem('ttt_playerNum', '1');
                        sessionStorage.setItem('ttt_gameID', match[1]);
                        window.location.href = BASE + '/play/' + match[1];
                        return;
                    }

                    throw new Error('Could not extract game ID');
                } else {
                    throw new Error('Server returned ' + res.status);
                }
            } catch (err) {
                console.error('Create game error:', err);
                alert('Failed to create game. Please try again.');
                btn.textContent = 'Create Game';
                btn.disabled = false;
            }
        });

        // Join game
        document.getElementById('joinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('joinBtn');
            const name = document.getElementById('joinName').value.trim();
            const gameID = document.getElementById('joinGameId').value.trim();

            if (!name || !gameID || gameID.length !== 4) return;

            btn.textContent = 'Joining...';
            btn.disabled = true;

            try {
                const formData = new URLSearchParams();
                formData.append('playerName', name);

                const res = await fetch(BASE + '/join/' + gameID, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });

                if (res.ok) {
                    sessionStorage.setItem('ttt_playerName', name);
                    sessionStorage.setItem('ttt_playerNum', '2');
                    sessionStorage.setItem('ttt_gameID', gameID);
                    window.location.href = BASE + '/play/' + gameID;
                } else {
                    const text = await res.text();
                    alert('Could not join: ' + text);
                    btn.textContent = 'Join Game';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('Connection error. Please try again.');
                btn.textContent = 'Join Game';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
